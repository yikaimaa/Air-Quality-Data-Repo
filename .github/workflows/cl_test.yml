name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        run: pip install uv

      - name: Install deps
        run: |
          uv venv
          uv pip install -r requirements.txt

      - name: Basic import check
        run: uv run python -c "import numpy, pandas"

      - name: Debug build_hourly_pm25.py version
        run: |
          echo "== does it contain second-pass? =="
          grep -n "second-pass" -n scripts/build_hourly_pm25.py || true
          echo "== show around lines 220-260 =="
          nl -ba scripts/build_hourly_pm25.py | sed -n '220,260p'
          echo "== search for old error message =="
          grep -n "still exist after merging" -n scripts/build_hourly_pm25.py || true


      # 1) build hourly (and panel)
      - name: Build hourly PM2.5
        run: |
          uv run python scripts/build_hourly_pm25.py --make-panel

      # 2) build daily from hourly
      - name: Build daily PM2.5
        run: |
          uv run python scripts/build_daily_pm25.py \
            --in-hourly data/processed/pm25_hourly_wide_final.csv \
            --out-daily data/processed/pm25_daily_cleaned.csv \
            --min-hours 15

      # 3) run EDA outputs to paper/eda
      - name: Generate EDA figures & tables
        run: |
          uv run python scripts/run_eda_paper.py \
            --outdir paper/eda \
            --formats png

      # Optional but very useful: upload outputs so you can download from the CI run
      - name: Upload outputs (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-outputs
          path: |
            data/processed/**
            paper/eda/**
